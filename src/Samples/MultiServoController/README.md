# 多舵机机器人控制器

基于 .NET IoT 的多关节舵机控制项目，支持自动角度映射和多舵机同步控制。

## 功能特性

- **自动角度映射**: 输入模型角度，自动转换为舵机实际控制角度
- **多舵机同步控制**: 支持同时控制多个舵机
- **预定义动作**: 内置多种机器人动作（初始化、点头、挥手、旋转）
- **交互式控制**: 支持实时角度调整和动作执行
- **错误处理**: 完善的I2C通信错误处理和重试机制

## 硬件配置

| 关节ID | 名称     | 模型角度范围 | 舵机角度范围 | I2C地址 | 是否反向 |
|--------|----------|-------------|-------------|---------|----------|
| 2      | 头部     | -15° ~ 15°  | 70° ~ 95°   | 0x02    | 是       |
| 4      | 左臂展开 | 0° ~ 30°    | -9° ~ 3°    | 0x04    | 否       |
| 6      | 左臂旋转 | 0° ~ 180°   | -16° ~ 117° | 0x06    | 否       |
| 8      | 右臂展开 | 0° ~ 30°    | 133° ~ 141° | 0x08    | 是       |
| 10     | 右臂旋转 | 0° ~ 180°   | 15° ~ 150°  | 0x0A    | 是       |
| 12     | 底部旋转 | -90° ~ 90°  | 0° ~ 180°   | 0x0C    | 否       |

## 使用方法

### 1. 基本控制

```csharp
using var robot = new RobotController();

// 启用关节
robot.SetJointEnable(2, true);

// 设置模型角度（自动转换为舵机角度）
robot.SetJointModelAngle(2, 10);  // 头部向右10度

// 同时控制多个关节
robot.SetMultipleJointAngles(new Dictionary<int, float>
{
    { 2, 0 },    // 头部居中
    { 4, 15 },   // 左臂展开一半
    { 6, 90 }    // 左臂旋转到中位
});
```

### 2. 预定义动作

```csharp
robot.PerformAction("初始化");  // 所有关节回到初始位置
robot.PerformAction("点头");    // 执行点头动作
robot.PerformAction("挥手");    // 执行挥手动作
robot.PerformAction("旋转");    // 执行底部旋转动作

// 新增循环往复测试动作
robot.PerformAction("循环测试");  // 逐个关节进行全范围循环往复运动
robot.PerformAction("同步测试");  // 所有关节同时进行同步循环运动
robot.PerformAction("波浪测试");  // 关节依次运动形成波浪效果
robot.PerformAction("头部测试");  // 单独测试头部关节
robot.PerformAction("手臂测试");  // 同步测试所有手臂关节
```

### 3. 循环往复测试功能

#### 单关节循环测试
```csharp
// 测试指定关节，3个循环，每步100ms延时
robot.PerformJointCycleTest(2, 3, 100);
```

#### 多关节同步循环测试
```csharp
// 多个关节同步运动测试
robot.PerformSynchronizedCycleTest(new int[] { 2, 4, 6 }, 2, 150);
```

#### 波浪式循环测试
```csharp
// 关节依次运动形成波浪效果
robot.PerformWaveCycleTest(3, 200);
```

#### 所有关节循环测试
```csharp
// 自动测试所有可用关节
robot.PerformAllJointsCycleTest(2, 100);
```

### 3. 交互式控制

运行程序后，可以通过命令行进行实时控制：

```
请输入命令: 2 10              # 将头部设置为10度
请输入命令: action 挥手        # 执行挥手动作
请输入命令: action 循环测试    # 执行所有关节循环测试
请输入命令: action 同步测试    # 执行多关节同步测试
请输入命令: action 波浪测试    # 执行波浪式测试
请输入命令: exit              # 退出程序
```

## 测试功能说明

### 循环往复测试类型

1. **单关节循环测试** (`PerformJointCycleTest`)
   - 测试指定关节在其完整角度范围内的循环往复运动
   - 可设置循环次数和步进延时
   - 自动计算合适的步进角度

2. **多关节同步测试** (`PerformSynchronizedCycleTest`)
   - 多个关节同时进行同步循环运动
   - 所有关节同时到达各自的最大/最小角度
   - 适合测试整体协调性

3. **波浪式测试** (`PerformWaveCycleTest`)
   - 关节依次运动，形成波浪传递效果
   - 正向和反向波浪交替进行
   - 适合测试动态效果

4. **全关节循环测试** (`PerformAllJointsCycleTest`)
   - 自动检测所有可用关节
   - 逐个进行循环测试
   - 适合完整的系统测试

### 测试参数说明

- **cycles**: 循环次数，控制测试重复次数
- **stepDelay**: 步进延时（毫秒），控制运动速度
- **waveDelay**: 波浪延时（毫秒），控制波浪传递速度

## 角度映射原理

项目实现了模型角度与舵机角度的自动映射：

- **正向映射**: 模型角度增大时，舵机角度增大
- **反向映射**: 模型角度增大时，舵机角度减小（适用于机械结构需要反向的关节）

映射公式：
```
正向: 舵机角度 = (模型角度 - 模型最小) / (模型最大 - 模型最小) * (舵机最大 - 舵机最小) + 舵机最小
反向: 舵机角度 = (模型角度 - 模型最小) / (模型最大 - 模型最小) * (舵机最小 - 舵机最大) + 舵机最大
```

## I2C 通信协议

- **启用/禁用命令**: `0xFF` + 启用标志
- **角度设置命令**: `0x01` + 4字节浮点角度值
- **角度读取命令**: `0x11`

## 依赖项

- .NET 8.0
- System.Device.Gpio
- Verdure.Iot.Device 项目引用

## 运行环境

- 支持 I2C 的设备（如 Raspberry Pi）
- 连接的 ServoF030 舵机控制器
