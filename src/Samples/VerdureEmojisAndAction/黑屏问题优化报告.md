# é»‘å±é—®é¢˜ä¼˜åŒ–æŠ¥å‘Š

## ðŸ” é—®é¢˜åˆ†æž

### åŽŸå§‹é—®é¢˜
åœ¨è¡¨æƒ…åˆ‡æ¢æ—¶å‡ºçŽ°é»‘å±é—ªçƒï¼Œå½±å“ç”¨æˆ·ä½“éªŒã€‚

### æ ¹æœ¬åŽŸå› 
1. **è‡ªåŠ¨æ¸…å±**: æ¯æ¬¡åœæ­¢æ’­æ”¾æ—¶éƒ½ä¼šè°ƒç”¨ `ClearScreen(true)`ï¼Œå¯¼è‡´å±å¹•å˜é»‘
2. **åˆ‡æ¢é€»è¾‘**: è¡¨æƒ…åˆ‡æ¢æ—¶å…ˆåœæ­¢å½“å‰æ’­æ”¾å¹¶æ¸…å±ï¼Œå†å¼€å§‹æ–°è¡¨æƒ…ï¼Œä¸­é—´å‡ºçŽ°é»‘å±é—´éš™
3. **åŒæ­¥é—®é¢˜**: å±å¹•æ¸…ç†å’Œæ–°å†…å®¹æ˜¾ç¤ºä¹‹é—´çš„æ—¶é—´é—´éš”é€ æˆè§†è§‰ä¸Šçš„é—ªçƒ

## ðŸ› ï¸ ä¼˜åŒ–æ–¹æ¡ˆ

### 1. æ™ºèƒ½åœæ­¢æ’­æ”¾æœºåˆ¶
```csharp
// ä¿®æ”¹å‰
await StopCurrentPlaybackAsync(); // æ€»æ˜¯æ¸…å±

// ä¿®æ”¹åŽ  
await StopCurrentPlaybackAsync(clearScreen: false); // å¯é€‰æ‹©æ˜¯å¦æ¸…å±
```

**ä¼˜åŠ¿:**
- è¡¨æƒ…åˆ‡æ¢æ—¶ä¿æŒæœ€åŽä¸€å¸§ï¼Œé¿å…é»‘å±
- æ˜Žç¡®éœ€è¦æ¸…å±æ—¶æ‰æ‰§è¡Œæ¸…ç†
- ç”¨æˆ·ä½“éªŒæ›´åŠ æµç•…

### 2. åˆ†ç¦»æŽ§åˆ¶é€‰é¡¹
**å‰ç«¯ç•Œé¢æ–°å¢žä¸¤ä¸ªæŒ‰é’®:**
- `â¸ï¸ åœæ­¢æ’­æ”¾`: ä»…åœæ­¢æ’­æ”¾ï¼Œä¿æŒç”»é¢
- `â¹ï¸ åœæ­¢å¹¶æ¸…å±`: åœæ­¢æ’­æ”¾å¹¶æ¸…é™¤å±å¹•

**APIæŽ¥å£ä¼˜åŒ–:**
- `POST /api/emotion/stop?clearScreen=false`: å¯é€‰æ¸…å±å‚æ•°
- `POST /api/emotion/clear-screen`: ä¸“é—¨çš„æ¸…å±æŽ¥å£

### 3. æ¸²æŸ“æ€§èƒ½ä¼˜åŒ–
```csharp
// æ·»åŠ ConfigureAwait(false)é¿å…æ­»é”
await Task.Run(() => _display24Inch.SendData(frameData), cancellationToken).ConfigureAwait(false);

// æ›´ç²¾ç¡®çš„å¸§çŽ‡æŽ§åˆ¶
if (delay < -frameDurationMs) {
    _logger.LogDebug($"å¸§æ¸²æŸ“è€—æ—¶è¿‡é•¿: {elapsed}ms");
}
```

### 4. å¢žå¼ºçš„æ¸…å±åŠŸèƒ½
```csharp
// æ”¯æŒè‡ªå®šä¹‰é¢œè‰²æ¸…å±
public void ClearScreen(bool is24Inch = true, ushort color = 0x0000)

// æ¸å˜æ¸…å±æ•ˆæžœ(å¯é€‰)
public async Task FadeToBlackAsync(bool is24Inch = true, int durationMs = 500)
```

## ðŸ“‹ ä¿®æ”¹æ–‡ä»¶åˆ—è¡¨

### æ ¸å¿ƒæœåŠ¡æ–‡ä»¶
1. **EmotionActionService.cs**
   - ä¿®æ”¹ `StopCurrentPlaybackAsync()` æ–¹æ³•ï¼Œæ·»åŠ å¯é€‰æ¸…å±å‚æ•°
   - ä¿®æ”¹ `PlayEmotionWithActionAsync()` åˆ‡æ¢æ—¶ä¸æ¸…å±
   - æ–°å¢ž `ClearEmotionScreenAsync()` ä¸“é—¨æ¸…å±æ–¹æ³•

2. **DisplayService.cs**
   - ä¼˜åŒ– `PlayEmotionAsync()` æ¸²æŸ“æ€§èƒ½
   - å¢žå¼º `ClearScreen()` æ”¯æŒé¢œè‰²å‚æ•°
   - æ–°å¢ž `FadeToBlackAsync()` æ¸å˜æ•ˆæžœ

### APIæŽ§åˆ¶å™¨
3. **EmotionController.cs**
   - ä¿®æ”¹ `/stop` æŽ¥å£æ”¯æŒå¯é€‰æ¸…å±å‚æ•°
   - æ–°å¢ž `/clear-screen` ä¸“é—¨æ¸…å±æŽ¥å£

### å‰ç«¯ç•Œé¢
4. **index.html**
   - åˆ†ç¦»åœæ­¢å’Œæ¸…å±æŒ‰é’®
   - æ–°å¢ž `clearScreen()` JavaScriptå‡½æ•°
   - ä¼˜åŒ–ç”¨æˆ·äº¤äº’ä½“éªŒ

## âœ… æ•ˆæžœå¯¹æ¯”

### ä¼˜åŒ–å‰
- è¡¨æƒ…åˆ‡æ¢: å½“å‰è¡¨æƒ… â†’ **é»‘å±é—ªçƒ** â†’ æ–°è¡¨æƒ…
- ç”¨æˆ·ä½“éªŒ: æ˜Žæ˜¾çš„è§†è§‰ä¸­æ–­
- æŽ§åˆ¶é€‰é¡¹: åªèƒ½åœæ­¢+æ¸…å±

### ä¼˜åŒ–åŽ  
- è¡¨æƒ…åˆ‡æ¢: å½“å‰è¡¨æƒ… â†’ **ç›´æŽ¥è¿‡æ¸¡** â†’ æ–°è¡¨æƒ…
- ç”¨æˆ·ä½“éªŒ: æµç•…æ— é—ªçƒ
- æŽ§åˆ¶é€‰é¡¹: åœæ­¢æ’­æ”¾ / åœæ­¢å¹¶æ¸…å±

## ðŸŽ¯ ä½¿ç”¨å»ºè®®

### æ­£å¸¸ä½¿ç”¨åœºæ™¯
- **è¡¨æƒ…åˆ‡æ¢**: ç›´æŽ¥ç‚¹å‡»æ–°è¡¨æƒ…æŒ‰é’®ï¼Œç³»ç»Ÿä¼šå¹³æ»‘åˆ‡æ¢
- **æš‚åœæ’­æ”¾**: ä½¿ç”¨"åœæ­¢æ’­æ”¾"ä¿æŒå½“å‰ç”»é¢
- **å®Œå…¨æ¸…é™¤**: ä½¿ç”¨"åœæ­¢å¹¶æ¸…å±"æ¸…é™¤å±å¹•å†…å®¹

### å¼€å‘è€…APIè°ƒç”¨
```csharp
// è¡¨æƒ…åˆ‡æ¢ (æŽ¨è)
await emotionService.PlayEmotionWithActionAsync(newRequest);

// ä»…åœæ­¢ (ä¿æŒç”»é¢)
await emotionService.StopCurrentPlaybackAsync(clearScreen: false);

// åœæ­¢å¹¶æ¸…å±
await emotionService.StopCurrentPlaybackAsync(clearScreen: true);

// ä¸“é—¨æ¸…å±
await emotionService.ClearEmotionScreenAsync();
```

## ðŸ”§ æŠ€æœ¯ç»†èŠ‚

### æ€§èƒ½ä¼˜åŒ–
- ä½¿ç”¨ `ConfigureAwait(false)` é¿å…æ­»é”
- ç²¾ç¡®çš„å¸§çŽ‡æŽ§åˆ¶å’Œæ€§èƒ½ç›‘æŽ§
- å¼‚æ­¥æ“ä½œä¼˜åŒ–å‡å°‘é˜»å¡ž

### ç”¨æˆ·ä½“éªŒ
- é›¶é»‘å±åˆ‡æ¢ä½“éªŒ
- å¯é€‰çš„è§†è§‰æ•ˆæžœæŽ§åˆ¶
- ç›´è§‚çš„ç•Œé¢æ“ä½œé€‰é¡¹

### å‘åŽå…¼å®¹
- ä¿æŒåŽŸæœ‰APIæŽ¥å£ä¸å˜
- æ–°å¢žåŠŸèƒ½ä¸ºå¯é€‰å‚æ•°
- æ¸è¿›å¼æ”¹è¿›ï¼Œä¸å½±å“çŽ°æœ‰åŠŸèƒ½

---

**æ€»ç»“**: é€šè¿‡æ™ºèƒ½çš„åœæ­¢æ’­æ”¾æœºåˆ¶å’Œä¼˜åŒ–çš„æ¸²æŸ“æµç¨‹ï¼Œå®Œå…¨è§£å†³äº†è¡¨æƒ…åˆ‡æ¢æ—¶çš„é»‘å±é—®é¢˜ï¼Œæä¾›æ›´æµç•…çš„ç”¨æˆ·ä½“éªŒã€‚
